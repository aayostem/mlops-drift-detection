version: "3.8"

services:
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_USER=mlflow
      - POSTGRES_PASSWORD=mlflow
      - POSTGRES_DB=mlflow
    networks:
      - mlops-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mlflow"]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  mlflow-tracking:
    build:
      context: .
      dockerfile: infrastructure/Dockerfile.mlflow
    ports:
      - "5000:5000"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow-tracking:5000
    volumes:
      - ./artifacts:/artifacts
    networks:
      - mlops-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  # Other services with simplified dependencies
  prefect-server:
    image: prefecthq/prefect:2-python3.9
    ports:
      - "4200:4200"
    command: prefect server start
    environment:
      - PREFECT_API_URL=http://prefect-server:4200/api
    networks:
      - mlops-network
    depends_on:
      - mlflow-tracking
    restart: unless-stopped

  ml-api:
    build:
      context: .
      dockerfile: infrastructure/Dockerfile.api
    ports:
      - "8000:8000"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow-tracking:5000
      - PREFECT_API_URL=http://prefect-server:4200/api
    networks:
      - mlops-network
    depends_on:
      - mlflow-tracking
      - prefect-server
    restart: unless-stopped

  monitoring:
    build:
      context: .
      dockerfile: infrastructure/Dockerfile.monitoring
    ports:
      - "8501:8501"
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow-tracking:5000
    networks:
      - mlops-network
    depends_on:
      - mlflow-tracking
    restart: unless-stopped

networks:
  mlops-network:
    driver: bridge
