# chaos-engineering/experiments/ml-platform-chaos.yaml

apiVersion: chaos-mesh.org/v1alpha1
kind: Schedule
metadata:
  name: ml-platform-weekly-chaos
  namespace: chaos-mesh
spec:
  schedule: "0 2 * * 0"  # Every Sunday at 2 AM
  startingDeadlineSeconds: 60
  concurrencyPolicy: "Forbid"
  historyLimit: 5
  workflow:
    templates:
    - name: network-latency-experiment
      templateType: NetworkChaos
      deadline: "10m"
      networkChaos:
        action: delay
        mode: all
        selector:
          namespaces: ["ml-platform"]
          labelSelectors:
            "app": "ml-model-api"
        delay:
          latency: "100ms"
          correlation: "85"
          jitter: "10ms"
        direction: "both"
        duration: "5m"

    - name: pod-failure-experiment
      templateType: PodChaos
      deadline: "5m"
      podChaos:
        action: pod-failure
        mode: one
        selector:
          namespaces: ["ml-platform"]
          labelSelectors:
            "app": "ml-model-api"
        duration: "2m"

    - name: cpu-stress-experiment
      templateType: StressChaos
      deadline: "10m"
      stressChaos:
        mode: one
        selector:
          namespaces: ["ml-platform"]
          labelSelectors:
            "app": "ml-model-api"
        stressors:
          cpu:
            workers: 4
            load: 80
        duration: "5m"

    - name: memory-stress-experiment
      templateType: StressChaos
      deadline: "8m"
      stressChaos:
        mode: one
        selector:
          namespaces: ["ml-platform"]
          labelSelectors:
            "app": "mlflow"
        stressors:
          memory:
            workers: 2
            size: "1Gi"
        duration: "3m"

---
apiVersion: chaos-mesh.org/v1alpha1
kind: Workflow
metadata:
  name: ml-platform-resilience-test
  namespace: chaos-mesh
spec:
  entry: "resilience-test"
  templates:
  - name: resilience-test
    templateType: Serial
    children:
    - "pre-test-health-check"
    - "chaos-experiments"
    - "post-test-health-check"
    - "generate-report"

  - name: pre-test-health-check
    templateType: Task
    task:
      container:
        image: curlimages/curl:latest
        command: ["curl"]
        args: ["-f", "https://api.mlplatform.company.com/health"]

  - name: chaos-experiments
    templateType: Parallel
    children:
    - "network-chaos"
    - "pod-chaos"
    - "stress-chaos"

  - name: network-chaos
    templateType: NetworkChaos
    networkChaos:
      action: delay
      mode: all
      selector:
        namespaces: ["ml-platform"]
        labelSelectors:
          "app": "ml-model-api"
      delay:
        latency: "50ms"
      duration: "3m"

  - name: pod-chaos
    templateType: PodChaos
    podChaos:
      action: pod-kill
      mode: one
      selector:
        namespaces: ["ml-platform"]
        labelSelectors:
          "app": "ml-model-api"
      gracePeriod: 0

  - name: stress-chaos
    templateType: StressChaos
    stressChaos:
      mode: one
      selector:
        namespaces: ["ml-platform"]
        labelSelectors:
          "app": "mlflow"
      stressors:
        cpu:
          workers: 2
          load: 50
      duration: "2m"

  - name: post-test-health-check
    templateType: Task
    task:
      container:
        image: curlimages/curl:latest
        command: ["curl"]
        args: 
        - "-f"
        - "-X"
        - "POST"
        - "-H"
        - "Content-Type: application/json"
        - "-d"
        - '{"features": [0.1, 0.2, 0.3]}'
        - "https://api.mlplatform.company.com/predict"

  - name: generate-report
    templateType: Task
    task:
      container:
        image: alpine:latest
        command: ["sh"]
        args:
        - "-c"
        - |
          echo "Chaos Engineering Test Report" > /report.txt
          echo "=============================" >> /report.txt
          echo "Test completed at: $(date)" >> /report.txt
          echo "All systems recovered successfully" >> /report.txt